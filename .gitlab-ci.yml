stages:
  - ansible:launch
  - ansible:init

.ansible:
  image: registry.gitlab.com/laitingsheng/docker-ansible:latest
  variables:
    ANSIBLE_LOAD_CALLBACK_PLUGINS: 1
    ANSIBLE_STDOUT_CALLBACK: debug
    ANSIBLE_HOST_KEY_CHECKING: 0
  before_script:
    - source project.sh
    - source ${OS_IDENTITY_FILE}
    - wget https://raw.githubusercontent.com/ansible/ansible/devel/contrib/inventory/openstack_inventory.py
    - chmod 755 openstack_inventory.py
    - chmod 600 ${K8S_MASTER_PRIVATE_KEY}
  only:
    refs:
      - master
      - ansible
    changes:
      - launch.yml
      - init.yml
      - project.sh
  except:
    - schedules

launch:
  stage: ansible:launch
  extends:
    - .ansible
  script:
    - ansible-playbook -i openstack_inventory.py -e public_key_path=${K8S_MASTER_PUBLIC_KEY} launch.yml

init:
  stage: ansible:init
  extends:
    - .ansible
  script:
    - ansible-playbook -i openstack_inventory.py --private-key ${K8S_MASTER_PRIVATE_KEY} -e k8s_scheduler_registry=${K8S_SCHEDULER_REGISTRY} -e k8s_scheduler_registry_username=${K8S_SCHEDULER_REGISTRY_USERNAME} -e k8s_scheduler_registry_password=${K8S_SCHEDULER_REGISTRY_PASSWORD} init.yml
  when: delayed
  start_in: 2 minutes
