stages:
  - launch
  - init
  - deploy

.ansible:
  image: registry.gitlab.com/laitingsheng/docker-ubuntu:k8s
  variables:
    ANSIBLE_LOAD_CALLBACK_PLUGINS: 1
    ANSIBLE_STDOUT_CALLBACK: debug
    ANSIBLE_HOST_KEY_CHECKING: 0
  before_script:
    - source project.sh
    - source $OS_IDENTITY_FILE
    - chmod 755 openstack_inventory.py
    - chmod 600 $K8S_MASTER_PRIVATE_KEY
  only:
    refs:
      - master
    changes:
      - launch.yml
      - init.yml
      - project.sh
  except:
    - schedules

launch:
  stage: launch
  extends:
    - .ansible
  script:
    - ansible-playbook -i openstack_inventory.py -e public_key_path=$K8S_MASTER_PUBLIC_KEY launch.yml

init:
  stage: init
  extends:
    - .ansible
  script:
    - ansible-playbook -i openstack_inventory.py --private-key $K8S_MASTER_PRIVATE_KEY -e k8s_scheduler_registry=$K8S_SCHEDULER_REGISTRY -e k8s_scheduler_registry_username=$K8S_SCHEDULER_REGISTRY_USERNAME -e k8s_scheduler_registry_password=$K8S_SCHEDULER_REGISTRY_PASSWORD init.yml
  when: delayed
  start_in: 2 minutes

.deploy:
  stage: deploy
  extends:
    - .ansible
  before_script:
    - source project.sh
    - source $OS_IDENTITY_FILE
    - chmod 755 openstack_inventory.py
    - chmod 600 $K8S_MASTER_PRIVATE_KEY
    - mkdir -p ~/.kube
    - python openstack_inventory.py --host T_R-k8s-master | grep accessIPv4 | awk -F' ' '{print $2}' | awk '{gsub(/[",]/, "")} 1' | xargs -i bash -c "scp -i $K8S_MASTER_PRIVATE_KEY ubuntu@{}:.kube/config ~/.kube/config"

monitoring:
  extends:
    - .deploy
  script:
    - kubectl apply -f monitoring/ || true
    - until kubectl get customresourcedefinitions servicemonitors.monitoring.coreos.com ; do date; sleep 1; echo ""; done
    - until kubectl get servicemonitors --all-namespaces ; do date; sleep 1; echo ""; done
    - kubectl apply -f monitoring/
  only:
    refs:
      - master
    changes:
      - launch.yml
      - init.yml
      - project.sh
      - monitoring/*
  except:
    - schedules

scheduler:
  extends:
    - .deploy
  script:
    - kubectl apply -f scheduler/
  only:
    refs:
      - master
    changes:
      - launch.yml
      - init.yml
      - project.sh
      - scheduler/*
  except:
    - schedules
