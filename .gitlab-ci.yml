stages:
  - image:ci
  - ansible:launch
  - ansible:init
  - scheduler:deploy

.docker:
  image: docker:stable
  services:
    - docker:dind
  before_script:
    - docker login -u ${CI_REGISTRY_USER} -p ${CI_REGISTRY_PASSWORD} ${CI_REGISTRY}

ci-image:ansible-openstack:
  stage: image:ci
  extends:
    - .docker
  script:
    - cd ansible-openstack
    - docker build -t ${CI_REGISTRY_IMAGE}/ansible-openstack .
    - docker push ${CI_REGISTRY_IMAGE}/ansible-openstack
  only:
    refs:
      - master
      - ci-image
    changes:
      - ansible-openstack/Dockerfile
  except:
    - schedules

ci-image:ansible-openstack:schedule-refresh:
  stage: image:ci
  extends:
    - .docker
  script:
    - docker pull ${CI_REGISTRY_IMAGE}/ansible-openstack
    - cd ansible-openstack
    - docker build --cache-from ${CI_REGISTRY_IMAGE}/ansible-openstack -t ${CI_REGISTRY_IMAGE}/ansible-openstack .
    - docker push ${CI_REGISTRY_IMAGE}/ansible-openstack
  only:
    - schedules

.ansible:
  image: ${CI_REGISTRY_IMAGE}/ansible-openstack
  variables:
    ANSIBLE_LOAD_CALLBACK_PLUGINS: 1
    ANSIBLE_STDOUT_CALLBACK: debug
    ANSIBLE_HOST_KEY_CHECKING: 0
  before_script:
    - source project.sh
    - source ${OS_IDENTITY_FILE}
    - wget https://raw.githubusercontent.com/ansible/ansible/devel/contrib/inventory/openstack_inventory.py
    - chmod 755 openstack_inventory.py
    - chmod 600 ${K8S_MASTER_PRIVATE_KEY}
  only:
    refs:
      - master
      - ansible
    changes:
      - launch.yml
      - init.yml
      - project.sh
  except:
    - schedules

launch:
  stage: ansible:launch
  extends:
    - .ansible
  script:
    - ansible-playbook -i openstack_inventory.py -e public_key_path=${K8S_MASTER_PUBLIC_KEY} launch.yml

init:
  stage: ansible:init
  extends:
    - .ansible
  script:
    - ansible-playbook -i openstack_inventory.py --private-key ${K8S_MASTER_PRIVATE_KEY} -e k8s_scheduler_registry=${K8S_SCHEDULER_REGISTRY} -e k8s_scheduler_registry_username=${K8S_SCHEDULER_REGISTRY_USERNAME} -e k8s_scheduler_registry_password=${K8S_SCHEDULER_REGISTRY_PASSWORD} init.yml
  when: delayed
  start_in: 2 minutes

deploy:
  stage: scheduler:deploy
  extends:
    - .ansible
  script:
    - ansible-playbook -i openstack_inventory.py --private-key ${K8S_MASTER_PRIVATE_KEY} deploy.yml
