- name: Add monitoring
  hosts: T_R-k8s-master
  gather_facts: no
  become: no
  remote_user: ubuntu
  tasks:
    - name: Create directory if not exists
      file:
        state: directory
        path: "~/manifests"
        mode: "755"
    - name: Upload manifests
      synchronize:
        src: "manifests"
        dest: "~/manifests"
        archive: yes
        delete: yes
    - name: Apply manifests
      shell: kubectl apply -f ~/manifests/
      ignore_errors: yes
    - name: Wait until all yaml files is applied
      shell: until kubectl get customresourcedefinitions servicemonitors.monitoring.coreos.com ; do date; sleep 1; echo ""; done
    - name: Wait for servicemonitors
      shell: until kubectl get servicemonitors --all-namespaces ; do date; sleep 1; echo ""; done
    - name: Apply Prometheus deployment set for the second time to resolve async error
      shell: kubectl apply -f ~/manifests/
